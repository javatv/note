---
layout: post
title: ReentranLock
---

# ReentranLock

é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œæƒ³æƒ³ä½ ç†è§£çš„éå…¬å¹³é”å’Œå…¬å¹³é”æ˜¯æ€æ ·çš„ï¼Ÿå†çœ‹å’Œæˆ‘ç†è§£çš„å·®åˆ«åœ¨å“ªé‡Œï¼Œçº¯å¼•æˆ˜ï¼Œä¸å¨±ä¹ğŸ˜›

## ä»€ä¹ˆæ˜¯ReentrantLock

`reentrant` ç¿»è¯‘ä¸ºå¯é‡å…¥çš„ï¼Œå› æ­¤ä»å­—é¢ä¸Šç¿»è¯‘ä¸º**å¯é‡å…¥é”**ï¼Œæˆ‘ä»¬çŸ¥é“å¯é‡å…¥æ˜¯æŒ‡ï¼šåŒä¸€ä¸ªçº¿ç¨‹å¯¹äºå·²ç»è·å¾—åˆ°çš„é”ï¼Œå¯ä»¥å¤šæ¬¡ç»§ç»­ç”³è¯·åˆ°è¯¥é”çš„ä½¿ç”¨æƒã€‚ReentrantLock åœ¨è°ƒç”¨ `lock()`æ–¹æ³•æ—¶ï¼Œå·²ç»è·å–åˆ°é”çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿå†æ¬¡è°ƒç”¨`lock()`æ–¹æ³•è·å–é”è€Œä¸è¢«é˜»å¡ã€‚

å¦‚æœè¦å®ç°è¯¥ç‰¹æ€§ï¼Œåˆ™éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

1. **çº¿ç¨‹å†æ¬¡è·å–é”**ã€‚é”éœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰å æ®é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚
2. **é”çš„æœ€ç»ˆé‡Šæ”¾**ã€‚çº¿ç¨‹é‡å¤ n æ¬¡è·å–äº†é”ï¼Œéšååœ¨ç¬¬ n æ¬¡é‡Šæ”¾è¯¥é”åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¯¥é”ã€‚é”çš„æœ€ç»ˆé‡Šæ”¾è¦æ±‚é”å¯¹äºè·å–è¿›è¡Œè®¡æ•°è‡ªå¢ï¼Œè®¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œè®¡æ•°è‡ªå‡ï¼Œå½“è®¡æ•°ç­‰äº 0 æ—¶è¡¨ç¤ºé”å·²ç»æˆåŠŸé‡Šæ”¾ã€‚

## å†è°ˆAQS

ä¹‹å‰å†™è¿‡ä¸€ç¯‡å…³äº[AQS](https://javatv.blog.csdn.net/article/details/107078990)çš„æ–‡ç« ï¼ŒAQSå…¨ç§°é˜Ÿåˆ—åŒæ­¥å™¨ `AbstractQueuedSynchronizer`ï¼Œå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ã€‚

æˆ‘ä»¬å¯ä»¥ AQS å’Œ ReentrantLock çš„å…³ç³»ç†è§£ä¸ºï¼š

- **é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„**ã€‚å®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸é”äº¤äº’çš„æ¥å£ï¼ˆæ¯”å¦‚å¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œè®¿é—®ï¼‰ï¼Œéšè—äº†å®ç°ç»†èŠ‚ã€‚
- **åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…**ã€‚å®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚

å®ƒæ—¢ç„¶æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé‚£å…¶ä¸­å¿…ç„¶ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨å†…éƒ¨ç±»ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å®ƒçš„ç»“æ„ï¼š

![image-20210926231108762](https://cdn.javatv.net/note/20210926231108.png)

å…¶ä¸­ Node ä¸­å„å±æ€§å¦‚ä¸‹ï¼š

| å±æ€§              | è¯´æ˜                                                         |
| ----------------- | ------------------------------------------------------------ |
| `Node SHARED`     | é”çš„æ¨¡å¼ï¼Œåˆ†ä¸ºå…±äº«ä¸ç‹¬å ï¼Œè¿™é‡Œä»£è¡¨å…±äº«                       |
| `Node EXCLUSIVE`  | ä»£è¡¨ç‹¬å                                                      |
| `int CANCELLED`   | å€¼ä¸º 1ï¼Œè¡¨ç¤ºå½“å‰çš„çº¿ç¨‹è¢«å–æ¶ˆ                                 |
| `int SIGNAL`      | å€¼ä¸º-1ï¼Œè¡¨ç¤ºåç»§ç»“ç‚¹åœ¨ç­‰å¾…å½“å‰ç»“ç‚¹å”¤é†’ã€‚åç»§ç»“ç‚¹å…¥é˜Ÿæ—¶ï¼Œä¼šå°†å‰ç»§ç»“ç‚¹çš„çŠ¶æ€æ›´æ–°ä¸ºSIGNAL |
| `int CONDITION`   | å€¼ä¸º -2ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾… conditionï¼Œä¹Ÿå°±æ˜¯åœ¨conditioné˜Ÿåˆ—ä¸­ |
| `int PROPAGATE`   | å€¼ä¸º -3ï¼Œè¡¨ç¤ºå½“å‰åœºæ™¯ä¸‹åç»­çš„ acquireShared èƒ½å¤Ÿå¾—ä»¥æ‰§è¡Œ     |
| `int waitStatus`  | è‹¥å€¼ä¸º 0ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ sync é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ç€è·å–é”           |
| `Node prev`       | å‰é©±èŠ‚ç‚¹                                                     |
| `Node next`       | åç»§ç»“ç‚¹                                                     |
| `Thread thread`   | èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹                                               |
| `Node nextWaiter` | ä¸‹ä¸€ä¸ªç­‰å¾…è€…                                                 |

å±æ€§å¾ˆå¤šï¼Œä½†æˆ‘ä»¬å¤§è‡´åªéœ€è¦è®°ä½æ¯ä¸ªNodeé‡Œé¢æœ€ä¸»è¦çš„ 3 ä¸ªï¼š

![image-20210927001447268](https://cdn.javatv.net/note/20210927001447.png)

æˆ‘ä»¬çŸ¥é“ AQS çš„è®¾è®¡æ˜¯åŸºäº**æ¨¡æ¿æ–¹æ³•æ¨¡å¼**çš„ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—çš„æ–¹æ³•è®©å®ç°è€…è‡ªå·±å»å®ç°ï¼Œå°±å¥½æ¯”å®šä¹‰ä¸€ä¸ªæ”¯ä»˜çš„æ–¹æ³•ï¼Œä½†æ˜¯å…¶å…·ä½“çš„å®ç°åŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜ï¼Œæ”¯ä»˜å®æ”¯ä»˜ï¼Œé“¶è¡Œå¡æ”¯ä»˜ç­‰ç­‰ã€‚è€Œ AQS ä¸­ä¸»è¦çš„æ¨¡æ¿æ–¹æ³•å¦‚ä¸‹ï¼š

| æ–¹æ³•                                | æè¿°                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| `boolean tryAcquire(int arg)`       | ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå®ç°è¯¥æ–¹æ³•å¾äºšæŸ¥è¯¢å½“å‰çŠ¶æ€å¹¶åˆ¤æ–­åŒæ­¥çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶ååœ¨è¿›è¡ŒCASè®¾ç½®åŒæ­¥çŠ¶æ€ |
| `boolean tryRelease(int arg)`       | ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†æœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€ |
| `int tryAcquireShared(int arg)`     | å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›å¤§äºç­‰äº0çš„å€¼ï¼Œè¡¨ç¤ºè·å–æˆåŠŸï¼Œåä¹‹ï¼Œè·å–å¤±è´¥ |
| `boolean tryReleaseShared(int arg)` | å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€                                           |
| `boolean isHeldExclusively()`       | å½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ï¼Œä¸€èˆ¬è¯¥æ–¹æ³•è¡¨ç¤ºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹æ‰€ç‹¬å  |

è€Œå¯¹äºå…¶ä¸­æ–¹æ³•æ¶‰åŠåˆ°çš„çŠ¶æ€ï¼ŒAQSå†…éƒ¨æä¾›äº†ä¸€ä¸ª`state`å±æ€§ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¼šè¢«å¹¶å‘è®¿é—®çš„å±æ€§ï¼Œä¸ºäº†é˜²æ­¢å‡ºç°**å¯è§æ€§**é—®é¢˜è¦ç”¨`volatile`è¿›è¡Œä¿®é¥°ï¼Œå¹¶ä¸”æä¾›äº†å¦‚ä¸‹ 3 ä¸ªæ–¹æ³•æ¥è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€ï¼š

- `getState()`ï¼šè·å–å½“å‰åŒæ­¥çŠ¶æ€ã€‚
- `setState(int newState)`ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ã€‚
- `compareAndSetState(int expect,int update)`ï¼šä½¿ç”¨ CAS è®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§ã€‚

å¦å¤–ï¼ŒAQS è¿˜æ‹¥æœ‰**é¦–èŠ‚ç‚¹ï¼ˆheadï¼‰**å’Œ**å°¾èŠ‚ç‚¹ï¼ˆtailï¼‰**ä¸¤ä¸ªå¼•ç”¨ï¼Œä¸€ä¸ªæŒ‡å‘**é˜Ÿåˆ—å¤´èŠ‚ç‚¹**ï¼Œè€Œå¦ä¸€ä¸ªæŒ‡å‘**é˜Ÿåˆ—å°¾èŠ‚ç‚¹**ï¼ˆå¤´èŠ‚ç‚¹æ²¡æœ‰å‰é©±ï¼Œå°¾ç»“ç‚¹æ²¡æœ‰åç»§ï¼‰ã€‚

**æ³¨æ„**ï¼šå› ä¸ºé¦–èŠ‚ç‚¹ head æ˜¯ä¸ä¿å­˜çº¿ç¨‹ä¿¡æ¯çš„èŠ‚ç‚¹ï¼Œä»…ä»…æ˜¯å› ä¸ºæ•°æ®ç»“æ„è®¾è®¡ä¸Šçš„éœ€è¦ï¼Œåœ¨æ•°æ®ç»“æ„ä¸Šï¼Œè¿™ç§åšæ³•å¾€å¾€å«åš**ç©ºå¤´èŠ‚ç‚¹é“¾è¡¨**ã€‚å¯¹åº”çš„å°±æœ‰**éç©ºå¤´ç»“ç‚¹é“¾è¡¨**ã€‚

å› æ­¤ï¼Œä¸€ä¸ª AQS æˆ‘ä»¬å¤§è‡´å¯ä»¥æŠ½è±¡ä¸ºï¼š

![image-20210927160935655](https://cdn.javatv.net/note/20210927160935.png)

## ReentrantLockå’ŒAQS

`ReentrantLock` æ˜¯åŸºäº `AQS` å®ç°çš„ï¼Œåœ¨`ReentrantLock` å†…éƒ¨æœ‰ä¸€ä¸ªå†…éƒ¨ç±»`Sync`ï¼Œå…¶ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š

![image-20210927112508997](https://cdn.javatv.net/note/20210927112516.png)

å…¶ä¸­å…·ä½“çš„æ–¹æ³•åœ¨ä¹‹å‰çš„æ–‡ç« æœ‰è®²è¿‡ï¼Œå¯ä»¥[è‡ªè¡Œå‚è€ƒ]()ï¼Œè¿™é‡Œä¸»è¦æ˜¯è®²éå…¬å¹³é”å’Œå…¬å¹³é”çš„åŠ é”æµç¨‹ã€‚

## éå…¬å¹³é”

### åŠ é”æµç¨‹

#### ä¸€ã€æœªåŠ é”

åœ¨æ²¡åŠ é”ä¹‹å‰AQSçš„çŠ¶æ€ï¼š

![image-20210927140127368](https://cdn.javatv.net/note/20210927140127.png)

#### äºŒã€ç¬¬ä¸€ä¸ªçº¿ç¨‹ t1 åŠ é”

1ã€**ReentrantLock()**ã€‚æ ¹æ®`ReentrantLock`çš„é»˜è®¤æ„é€ æ–¹æ³•å¯çŸ¥ï¼Œå½“`new ReentrantLock()`ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”ã€‚

```java
public ReentrantLock() {
    sync = new NonfairSync();
}
```

2ã€**lock()**ã€‚å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å»è·å–é”ï¼Œä»`Lock.lock()`æ–¹æ³•å¼€å§‹ã€‚

```java
public void lock() {
    sync.lock();
}
```

3ã€**NonfairSync.lock()**ã€‚è¿›å…¥éå…¬å¹³é”çš„å®ç°æ–¹æ³•ä¸­ï¼Œå¹¶ä¸”è·å–é”ã€‚

```java
final void lock() {
	//æ¯”è¾ƒå¹¶è®¾ç½®çŠ¶æ€æˆåŠŸï¼ŒçŠ¶æ€0è¡¨ç¤ºé”æ²¡æœ‰è¢«å ç”¨
    if (compareAndSetState(0, 1))
    	//æŠŠå½“å‰çº¿ç¨‹è®¾ç½®ç‹¬å äº†é”
        setExclusiveOwnerThread(Thread.currentThread());
    else //é”å·²ç»è¢«å ç”¨ï¼Œæˆ–è€…setå¤±è´¥
        acquire(1); //ä»¥ç‹¬å æ¨¡å¼è·å–å¯¹è±¡ï¼Œå¿½ç•¥ä¸­æ–­
}
```

4ã€**compareAndSetState()**ã€‚åœ¨è·å–é”ä¹‹å‰å…ˆé€šè¿‡`CAS`çš„æ–¹å¼å°†`AQS`ä¸­çš„çŠ¶æ€`state`ï¼Œ

- `state == 0`ï¼Œ è¡¨ç¤ºè¯¥é”ä¸è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ã€‚
- `state == 1`ï¼Œè¡¨ç¤ºçº¿ç¨‹æ°å¥½æŒæœ‰è¯¥é”1æ¬¡ï¼ˆæœªé‡å…¥ï¼‰ã€‚
- `state > 1`ï¼Œè¡¨ç¤ºé”è¢«çº¿ç¨‹é‡å…¥ state æ¬¡ã€‚

```java
protected final boolean compareAndSetState(int expect, int update) {
    // See below for intrinsics setup to support this
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼Œ`state`çš„é»˜è®¤å€¼ä¸º 0 ï¼Œé€šè¿‡CASå°†`state`çš„çŠ¶æ€æ”¹ä¸º 1ï¼Œå¹¶ä¸”é€šè¿‡`setExclusiveOwnerThread()`æŠŠå½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å é”ï¼Œç„¶åè¿”å›æˆåŠŸçš„ç»“æœã€‚

æ­¤æ—¶AQSçš„çŠ¶æ€ä¸ºï¼š

![image-20210927140144413](https://cdn.javatv.net/note/20210927140144.png)

#### ä¸‰ã€ç¬¬äºŒä¸ªçº¿ç¨‹ t2 åŠ é”

å½“ç¬¬äºŒä¸ªçº¿ç¨‹æ¥åŠ é”ï¼Œæ­¤æ—¶å­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯æ˜¯`t1`å·²ç»é‡Šæ”¾é”äº† ï¼Œç¬¬äºŒ`t1`çº¿ç¨‹å·²ç»è¿˜æŒæœ‰é”æœªé‡Šæ”¾ã€‚

5ã€è‹¥`t1`å·²ç»é‡Šæ”¾é”ï¼Œæ­¤æ—¶AQSå°±æ˜¯å¤„äºæœªåŠ é”çš„çŠ¶æ€ï¼Œæ­¤æ—¶`t2`æ¥åŠ é”å’Œçº¿ç¨‹`t1`çš„æ­¥éª¤ç›¸åŒã€‚

![image-20210927141151670](https://cdn.javatv.net/note/20210927141151.png)

ç”±æ­¤å¯å¾—å‡ºç»“è®ºï¼Œ**ReentrantLockå¦‚æœçº¿ç¨‹ä¹‹é—´æ²¡æœ‰ç«äº‰ï¼Œé‚£ä¹ˆå…¶æ•ˆç‡éå¸¸é«˜ï¼Œç”šè‡³é˜Ÿåˆ—éƒ½æ²¡æœ‰åˆå§‹åŒ–**ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ`t1`è¿›æ¥å°±é€šè¿‡ CAS è·å–é”çš„åŸå› ã€‚

å½“ç„¶ï¼Œæ—¢ç„¶ä½¿ç”¨åˆ°é”äº†ï¼Œé‚£å¿…ç„¶æ˜¯ä¸ºäº†é«˜å¹¶å‘åœºæ™¯åšå‡†å¤‡çš„ã€‚

6ã€**acquire()**ã€‚è‹¥`t1`æœªé‡Šæ”¾é”ï¼Œæ­¤æ—¶`t2`æƒ³æ¥è·å–é”ï¼Œé‚£ä¹ˆ CAS å°±ä¼šå¤±è´¥ï¼Œä»è€Œè¿›å…¥`acquire()`æ–¹æ³•ã€‚

```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) && //å½“å‰çº¿ç¨‹å°è¯•è·å–é”,è‹¥è·å–æˆåŠŸè¿”å›true,å¦åˆ™false
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```

è¯¥æ–¹æ³•ä¸»è¦çš„é€»è¾‘éƒ½åœ¨ if åˆ¤æ–­æ¡ä»¶ä¸­ï¼Œè¿™é‡Œé¢æœ‰ 3 ä¸ªé‡è¦çš„æ–¹æ³•`tryAcquire()`ï¼Œ`addWaiter()`å’Œ`acquireQueued()`ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•ä¸­åˆ†åˆ«å°è£…äº†åŠ é”æµç¨‹ä¸­çš„ä¸»è¦å¤„ç†é€»è¾‘ï¼Œç†è§£äº†è¿™ä¸‰ä¸ªæ–¹æ³•åˆ°åº•åšäº†å“ªäº›äº‹æƒ…ï¼Œæ•´ä¸ªåŠ é”æµç¨‹å°±æ¸…æ™°äº†ã€‚

7ã€**tryAcquire()**ã€‚å½“å‰çº¿ç¨‹å°è¯•è·å–é”ï¼Œè‹¥è·å–æˆåŠŸè¿”å›trueï¼Œå¦åˆ™falseã€‚å®ƒæ˜¯ AQS ä¸­å®šä¹‰çš„æ¨¡æ¿æ–¹æ³•ï¼ŒReentrantLockåœ¨å…¬å¹³å’Œéå…¬å¹³æ¨¡å¼ä¸‹å¯¹æ­¤æœ‰ä¸åŒå®ç°ï¼Œéå…¬å¹³æ¨¡å¼çš„å®ç°å¦‚ä¸‹ï¼š

```
protected final boolean tryAcquire(int acquires) {
    return nonfairTryAcquire(acquires);
}
```

åº•å±‚è°ƒç”¨äº†`nonfairTryAcquire()`ï¼Œä»æ–¹æ³•åä¸Šæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“è¿™æ˜¯éå…¬å¹³æ¨¡å¼ä¸‹å°è¯•è·å–é”çš„æ–¹æ³•,å…·ä½“æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š

```java
//acquires == 1
final boolean nonfairTryAcquire(int acquires) {
	//è·å–å½“å‰çº¿ç¨‹
    final Thread current = Thread.currentThread();
    //è·å–stateå˜é‡çš„å€¼,å³å½“å‰é”è¢«é‡å…¥çš„æ¬¡æ•°
    int c = getState();
    if (c == 0) {//stateä¸º0,è¯´æ˜å½“å‰é”æœªè¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ï¼Œå³t1å·²ç»é‡Šæ”¾äº†
    	//é€šè¿‡ CAS è·å–é”ï¼ŒåŒç¬¬ä¸€ä¸ªçº¿ç¨‹åŠ é”æ–¹å¼
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    //å¦‚æœstateä¸ä¸º0ä¸”ä¸ºå½“å‰çº¿ç¨‹ï¼Œè¯´æ˜åŒä¸€çº¿ç¨‹é”é‡å…¥
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        //æ›´æ–°state
        setState(nextc);
        return true;
    }
    //å¦åˆ™è·å–é”å¤±è´¥
    return false;
}
```

è¿™é‡Œä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å› falseï¼Œä¸»è¦åŸå› æ˜¯å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œå‡å¦‚åœ¨`t2`åˆšè¿›å…¥`nonfairTryAcquire()`æ–¹æ³•ï¼Œ`t1`å°±é‡Šæ”¾äº†ï¼Œé‚£å®ƒå°±å¯ä»¥ç«‹é©¬æ‹¿å–é”ï¼Œæ•ˆç‡é«˜ï¼Œå› ä¸ºå°‘äº†é‚£äº›æ²¡å¿…è¦çš„åˆ¤æ–­ã€‚

8ã€**acquireQueued()**ã€‚å½“`tryAcquire()`å¤±è´¥ï¼Œå³è¿”å› false ä¹‹åæ‰ä¼šæ‰§è¡Œã€‚è¯¥æ–¹æ³•ä¸»è¦æ˜¯å°†**è·å–é”å¤±è´¥çš„çº¿ç¨‹å®‰å…¨çš„åŠ å…¥åŒæ­¥é˜Ÿåˆ—**ã€‚

è¯¥æ–¹æ³•è°ƒç”¨äº†`addWaiter()`ï¼Œä¸”ä¼ å…¥äº†ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹`Node.EXCLUSIVE = null`ï¼Œå…¶ä»£ç å®ç°å¦‚ä¸‹ï¼š

```java
//mode = null
private Node addWaiter(Node mode) {
	//é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹,å¹¶å°†å½“å‰çº¿ç¨‹å®ä¾‹å°è£…åœ¨å†…éƒ¨,modeè¿™é‡Œä¸ºnull
	//å¹¶ä¸”modeèµ‹å€¼ç»™NodeèŠ‚ç‚¹çš„ nextWaiter
    Node node = new Node(Thread.currentThread(), mode);
    // Try the fast path of enq; backup to full enq on failure
    Node pred = tail;//ç¬¬ä¸€æ¬¡åŠ é”çš„æ—¶å€™é˜Ÿåˆ—è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå› æ­¤ç¬¬äºŒæ¬¡åŠ é”çš„æ—¶å€™tail = null
    if (pred != null) {
        node.prev = pred;
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    enq(node);
    return node;
}
```

ç”±äºç¬¬ä¸€æ¬¡åŠ é”é˜Ÿåˆ—è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå› æ­¤ç¬¬äºŒæ¬¡åŠ é”çš„æ—¶å€™`tail = null`ï¼Œæ‰€ä»¥ç›´æ¥èµ°`enq()`æ–¹æ³•ï¼Œå…¶ä¸­  `for(;;)`å’Œ`while(true)`æ•ˆæœä¸€è‡´ã€‚

```java
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        //è‹¥tailä¸ºnullï¼Œè¯´æ˜é˜Ÿåˆ—æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹
        if (t == null) { // Must initialize
            //æ„é€ æ–°ç»“ç‚¹,CASæ–¹å¼è®¾ç½®ä¸ºé˜Ÿåˆ—é¦–å…ƒç´ ,å½“head==nullæ—¶æ›´æ–°æˆåŠŸ
            if (compareAndSetHead(new Node()))
            	//å¤´ç»“ç‚¹ä¸å°¾ç»“ç‚¹éƒ½æŒ‡å‘åŒä¸€ä¸ªæ–°ç”Ÿç»“ç‚¹
                tail = head;
        } else {//è‹¥tailä¸ä¸ºnullï¼Œå³å·²ç»è¢«åˆå§‹åŒ–è¿‡
        	//å°†nodeç»“ç‚¹çš„prevè¿æ¥åˆ°åŸå°¾ç»“ç‚¹
            node.prev = t;
            //CASæ¯”è¾ƒç»“ç‚¹tæ˜¯å¦ä¸ºå°¾ç»“ç‚¹ï¼Œè‹¥æ˜¯åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºnode
            if (compareAndSetTail(t, node)) {
            	//æŠŠåŸå°¾ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹node
                t.next = node;
                return t;
            }
        }
    }
}
```

æŒ‰ç…§æ­¥éª¤åˆ†æï¼š

â‘ `if (t == null)`ï¼Œè¯´æ˜é˜Ÿåˆ—æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹ï¼ŒCASæ–¹å¼è®¾ç½®ä¸ºé˜Ÿåˆ—é¦–å…ƒç´ ï¼Œå½“`head==null`æ—¶æ›´æ–°æˆåŠŸï¼Œå¹¶æŠŠå°¾æŒ‡é’ˆæŒ‡å‘é¦–ç»“ç‚¹ã€‚

![image-20210927155835324](https://cdn.javatv.net/note/20210927155835.png)

â‘¡ å½“ç¬¬äºŒæ¬¡å¾ªç¯`t != null`ï¼Œå³å·²ç»è¢«åˆå§‹åŒ–è¿‡ï¼Œå°† node ç»“ç‚¹çš„ prev è¿æ¥åˆ°å°¾ç»“ç‚¹ï¼ŒCASæ¯”è¾ƒç»“ç‚¹ t æ˜¯å¦ä¸ºå°¾ç»“ç‚¹ï¼Œè‹¥æ˜¯åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸º nodeï¼Œç„¶åæŠŠåŸå°¾ç»“ç‚¹çš„ next æŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹ nodeã€‚

æˆ‘ä»¬å¯ä»¥å†™ä¸€æ®µä»£ç å»æŸ¥çœ‹å¯¹è±¡çš„èµ‹å€¼æƒ…å†µã€‚

```java
public static void main(String[] args) {
    ReentrantLock lock = new ReentrantLock();
    //t1é¦–å…ˆè·å–é” ç„¶åé˜»å¡5s
    Thread t1 = new Thread(() -> {
        try {
            lock.lock();//è·å–é”
            //ç¡çœ 
            TimeUnit.SECONDS.sleep(Integer.MAX_VALUE);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }, "t1");
    t1.start()
        
    //ä¸»è¦æ˜¯ä¸ºäº†è®©t1å…ˆæ‹¿åˆ°é”
    TimeUnit.SECONDS.sleep(1);
    
    //t2åŠ é”å¤±è´¥å› ä¸ºè¢«t1æŒæœ‰
    Thread t2 = new Thread(() -> {
        try {
            lock.lock();
            System.out.println("t2 è·å–äº†é”--æ‰§è¡Œä»£ç ");
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }, "t2");
    t2.start();
}
```

åˆå§‹åŒ–ä¹‹å

![image-20210927165500794](https://cdn.javatv.net/note/20210927165500.png)

æ­¤æ—¶ï¼ŒAQS çš„é˜Ÿåˆ—ä¸ºï¼š

![image-20210927170131563](https://cdn.javatv.net/note/20210927170131.png)

åœ¨æ­»å¾ªç¯ä¸­åªæœ‰é€šè¿‡ CAS å°†èŠ‚ç‚¹è®¾ç½®æˆä¸ºå°¾èŠ‚ç‚¹ä¹‹åï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½ä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå½“å‰çº¿ç¨‹ä¸æ–­åœ°å°è¯•è®¾ç½®ã€‚èŠ‚ç‚¹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œåœ¨å›å¤´çœ‹`acquireQueued()`æ–¹æ³•ï¼š

```java
final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        //æ­»å¾ªç¯,æ­£å¸¸æƒ…å†µä¸‹çº¿ç¨‹åªæœ‰è·å¾—é”æ‰èƒ½è·³å‡ºå¾ªç¯
        for (;;) {
        	//è·å–èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹
            final Node p = node.predecessor();
            if (p == head && tryAcquire(arg)) {//å‰é©±ä¸ºå¤´ç»“ç‚¹å¹¶ä¸”æˆåŠŸè·å¾—é”
            	//å°†å½“å‰ç»“ç‚¹è®¾ç½®ä¸ºé˜Ÿåˆ—å¤´ç»“ç‚¹
                setHead(node);
                p.next = null; // help GC åˆ é™¤åŸæœ‰å¤´èŠ‚ç‚¹
                failed = false;
                return interrupted;
            }
            //åˆ¤æ–­æ˜¯å¦è¦é˜»å¡å½“å‰çº¿ç¨‹
            if (shouldParkAfterFailedAcquire(p, node) &&
            	//çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’(é”è¢«é‡Šæ”¾çš„æ—¶å€™å”¤é†’)
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
```

1. åœ¨ç¬¬ä¸€ä¸ª if è¯­å¥ä¸­ï¼Œå…ˆä¼šåˆ¤æ–­å‰é©±ç»“ç‚¹æ˜¯å¦æ˜¯å¤´ç»“ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™å°è¯•è·å–é”ï¼Œè·å–é”æˆåŠŸåˆ™ä¼šè®¾ç½®å½“å‰ç»“ç‚¹ä¸ºå¤´ç»“ç‚¹(æ›´æ–°å¤´æŒ‡é’ˆ)ã€‚**ä¸ºä»€ä¹ˆå¿…é¡»å‰é©±ç»“ç‚¹ä¸ºå¤´ç»“ç‚¹æ‰å°è¯•å»è·å–é”ï¼Ÿ**å…ˆä¸ç®¡æˆ‘ä»¬å…ˆçœ‹ç¬¬äºŒä¸ª if åˆ¤æ–­ã€‚
2. ç¬¬äºŒä¸ª if è¯­å¥ä¸­ï¼Œ`shouldParkAfterFailedAcquire()`ï¼Œå­—é¢æ„æ€æŒºå¥½ç†è§£ï¼Œåœ¨è·å–èµ„æºå¤±è´¥ä¹‹åæ˜¯å¦éœ€è¦é˜»å¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
// å½“è·å–(èµ„æº)å¤±è´¥åï¼Œæ£€æŸ¥å¹¶ä¸”æ›´æ–°ç»“ç‚¹çŠ¶æ€
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
	// è·å–å‰é©±ç»“ç‚¹çš„çŠ¶æ€
    int ws = pred.waitStatus;
    //predçŠ¶æ€ä¸ºSIGNAL,åˆ™è¿”å›true,è¡¨ç¤ºè¦é˜»å¡å½“å‰çº¿ç¨‹
    if (ws == Node.SIGNAL)
        /*
         * This node has already set status asking a release
         * to signal it, so it can safely park.
         */
        return true;
    if (ws > 0) {// è¡¨ç¤ºçŠ¶æ€ä¸ºCANCELLEDï¼Œä¸º1
        //æ‰¾åˆ°predç»“ç‚¹å‰é¢æœ€è¿‘çš„ä¸€ä¸ªçŠ¶æ€ä¸ä¸ºCANCELLEDçš„ç»“ç‚¹
        do {
            node.prev = pred = pred.prev;
        } while (pred.waitStatus > 0);
        // èµ‹å€¼predç»“ç‚¹çš„nextåŸŸ
        pred.next = node;
    } else {
        //ä¸ºPROPAGATE -3 æˆ–è€…æ˜¯ 0 è¡¨ç¤ºæ— çŠ¶æ€,(ä¸ºCONDITION -2æ—¶ï¼Œè¡¨ç¤ºæ­¤èŠ‚ç‚¹åœ¨condition queueä¸­) 
        // æ¯”è¾ƒå¹¶è®¾ç½®å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    return false;
}
```

è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºåªæœ‰å½“è¯¥èŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸º`SIGNAL`æ—¶ï¼Œæ‰å¯ä»¥å¯¹è¯¥ç»“ç‚¹æ‰€å°è£…çš„çº¿ç¨‹è¿›è¡Œparkæ“ä½œã€‚å¦åˆ™ï¼Œå°†ä¸èƒ½è¿›è¡Œ park æ“ä½œã€‚å…¶ä¸­å„å±æ€§å¦‚ä¸‹ï¼š

- `int CANCELLED = 1`ï¼Œå³`waitStatus`å€¼ä¸º 1 ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹èŠ‚ç‚¹å·²é‡Šæ”¾ï¼ˆè¶…æ—¶ã€ä¸­æ–­ï¼‰ï¼Œå·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸ä¼šå†é˜»å¡ã€‚
- `int SIGNAL  = -1`ï¼Œå³`waitStatus`ä¸º -1 ï¼Œè¡¨ç¤ºå‰é©±èŠ‚ç‚¹å·²ç»è®¾ç½®äº†`SIGNAL`ï¼Œé—¹é’Ÿå·²ç»è®¾å¥½ï¼Œç°åœ¨æˆ‘å¯ä»¥å®‰å¿ƒç¡è§‰ï¼ˆé˜»å¡ï¼‰äº†ã€‚å¦‚æœå‰é©±å˜æˆäº†headï¼Œå¹¶ä¸”headçš„ä»£è¡¨çº¿ç¨‹ exclusiveOwnerThread é‡Šæ”¾äº†é”ï¼Œå°±ä¼šæ¥æ ¹æ®è¿™ä¸ªSIGNALæ¥å”¤é†’è‡ªå·±ã€‚
- `int CONDITION = -2`ï¼Œå³`waitStatus`ä¸º -2 ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹åœ¨`Condition`é˜Ÿåˆ—ä¸­é˜»å¡ï¼ˆConditionæœ‰ä½¿ç”¨ï¼‰
-  `int PROPAGATE = -3`ï¼Œå³`waitStatus`ä¸º -3ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹ä»¥åŠåç»­çº¿ç¨‹è¿›è¡Œæ— æ¡ä»¶ä¼ æ’­ï¼ˆ`CountDownLatch`ä¸­æœ‰ä½¿ç”¨ï¼‰å…±äº«æ¨¡å¼ä¸‹ï¼Œ `PROPAGATE` çŠ¶æ€çš„çº¿ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€ ã€‚

å†çœ‹`parkAndCheckInterrupt()`æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š

```java
private final boolean parkAndCheckInterrupt() {
    //park å½“å‰çº¿ç¨‹
    LockSupport.park(this);
    //è°ƒç”¨ Thread.interrupted()æ–¹æ³•è¿”å›ä¸­æ–­çŠ¶æ€ï¼Œå¹¶ä¸”é‡ç½®ä¸­æ–­çŠ¶æ€
    return Thread.interrupted();
}
```

**ä½¿ç”¨ LockSupport.park æŒ‚èµ·å½“å‰çº¿ç¨‹å˜æˆ WATING çŠ¶æ€**ï¼Œå…³äºLockSupportå¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[LockSupportåŠŸèƒ½ç®€ä»‹åŠåŸç†æµ…æ](https://www.cnblogs.com/takumicx/p/9328459.html)

`Thread.interrupted()`ï¼Œè¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è§¦å‘è¿‡ä¸­æ–­è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯`Thread.interrupt()`ï¼Œ å¦‚æœæœ‰è§¦å‘è¿‡ä¸­æ–­è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›å½“å‰çš„ä¸­æ–­æ ‡è¯† trueï¼Œå¹¶ä¸”å¯¹ä¸­æ–­æ ‡è¯†è¿›è¡Œå¤ä½æ ‡è¯†å·²ç»å“åº”è¿‡äº†ä¸­æ–­è¯·æ±‚ã€‚å¦‚æœè¿”å› trueï¼Œæ„å‘³ç€åœ¨ `acquire()` æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ `selfInterrupt()`ã€‚

```java
static void selfInterrupt() {
    Thread.currentThread().interrupt();
}
```

å› æ­¤ï¼Œ`selfInterrupt()` æ‰§è¡Œçš„å‰ææ˜¯ `acquireQueued(addWaiter(Node.EXCLUSIVE), arg)`æ–¹æ³•è¿”å› trueã€‚è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ˜¯çº¿ç¨‹åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­æ˜¯å¦å‘ç”Ÿè¿‡ä¸­æ–­ï¼Œè¿”å› true åˆ™è¯æ˜å‘ç”Ÿè¿‡ä¸­æ–­ã€‚æ‰€ä»¥ `acquire()` ä¸­çš„ `selfInterrupt()` å…¶å®æ˜¯å¯¹è·å–é”çš„è¿‡ç¨‹ä¸­å‘ç”Ÿè¿‡çš„ä¸­æ–­çš„è¡¥å……ã€‚

æ€ä¹ˆç†è§£ï¼Ÿä¸ºä»€ä¹ˆ `park`ä¹‹åè¦è°ƒç”¨`Thread.interrupted()`ä»¥åŠ`selfInterrupt()`ã€‚

å½“è°ƒç”¨äº† LockSupport çš„ park åï¼Œè¯¥çº¿ç¨‹ä» park æ–¹æ³•è¿”å›çš„æƒ…å†µæœ‰ä¸¤ç§ï¼š

1. ä¸€ç§æ˜¯å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†èµ„æºï¼Œè°ƒç”¨äº†è¯¥çº¿ç¨‹çš„ `unpark` æ–¹æ³•ã€‚

   å¦‚æœæ˜¯è¢«è°ƒç”¨äº†`unpark` æ–¹æ³•ï¼Œé‚£ä¹ˆ `Thread.interrupted()` å°†è¿”å› falseï¼Œç„¶åè¿›å…¥å¾ªç¯ä»£ç ç»§ç»­å°è¯•è·å–é”ï¼Œè¿™ä¸€æ­¥å°±æ˜¯æ­£å¸¸æƒ…å†µã€‚

2. å¦å¤–ä¸€ç§å°±æ˜¯è¯¥çº¿ç¨‹è¢«æŸäº›çº¿ç¨‹ç»™ä¸­æ–­äº†ï¼Œä½†æ˜¯å¦‚æœæ˜¯å› ä¸ºçº¿ç¨‹è¢«ä¸­æ–­è€Œè¿”å›ï¼Œé‚£ä¹ˆ`Thread.interrupted()` å°†è¿”å› trueï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹ä»å¾ªç¯ä¸­è·å–åˆ°äº†èµ„æºï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šè°ƒç”¨`selfInterrupt()` è¿™ä¸ªæ–¹æ³•ï¼Œæ­¤æ—¶åˆä¼šä¸­æ–­è¯¥çº¿ç¨‹ã€‚

   é—®é¢˜æ¥äº†ï¼Œ**ä¸ºä»€ä¹ˆè·å–åˆ°é”åè¦è¿›è¡Œä¸€æ¬¡ä¸­æ–­ï¼Ÿ**ä¸ªäººè§‰å¾—è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†è¯¥çº¿ç¨‹çš„ä¸­æ–­ä¿¡æ¯ä¸è¢«åƒæ‰ï¼Œå½“è°ƒç”¨ park æ–¹æ³•é˜»å¡åï¼Œå¦‚æœè¢«ä¸­æ–­äº†ï¼Œé‚£ä¹ˆç»§ç»­å›å»è·å–é”ï¼Œè·å–é”åï¼Œä¼šå†æ¬¡ä¸­æ–­è‡ªå·±ï¼Œè®©ä¸Šå±‚è°ƒç”¨è€…è·å–åˆ°è‡ªå·±è¢«ä¸­æ–­çš„ä¿¡æ¯ï¼Œç”±ä¸Šå±‚è°ƒç”¨è€…å†³å®šæ˜¯å¦å¯¹ä¸­æ–­å¤„ç†ï¼Œè€Œä¸æ˜¯æ‚„æ‚„æŠŠä¸­æ–­ä¿¡æ¯åƒæ‰ã€‚å› ä¸ºæˆ‘ä»¬çŸ¥é“`lock()`æ–¹æ³•æ˜¯ä¸èƒ½è¢«ä¸­æ–­çš„ã€‚

   å¯ä»¥å‚è€ƒ `lockInterruptibly()` è¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œé¢å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯è°ƒç”¨ park åï¼Œå¦‚æœçº¿ç¨‹å‘ç”Ÿäº†ä¸­æ–­ï¼Œåˆ™ç›´æ¥æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»è·å–é”äº†ã€‚

   ![image-20210927232702599](https://cdn.javatv.net/note/20210927232709.png)

9ã€`cancelAcquire()`ã€‚ç„¶ååœ¨`acquireQueued()`çš„ final å—ä¸­è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•`cancelAcquire()`ï¼Œè¯¥æ–¹æ³•å®Œæˆçš„åŠŸèƒ½å°±æ˜¯å–æ¶ˆå½“å‰çº¿ç¨‹å¯¹èµ„æºçš„è·å–ï¼Œå³è®¾ç½®è¯¥ç»“ç‚¹çš„çŠ¶æ€ä¸º**CANCELLED**ï¼Œä¸€èˆ¬æ¥è¯´æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œè€Œä¸”å¯¹åŠ é”è¿‡ç¨‹å½±å“ä¸æ˜¯å¾ˆå¤§ï¼Œè‡³å°‘æˆ‘æ²¡çœ‹å‡ºä»€ä¹ˆå½±å“ï¼Œå¹¶ä¸”æš‚æ—¶æ²¡æƒ³åˆ°ä»€ä¹ˆåœºæ™¯å»é€‚é…ï¼Œæ‰€ä»¥è¿™é‡Œä¸åœ¨ç»†ç©¶ã€‚

```java
//å–æ¶ˆç»§ç»­è·å–(èµ„æº)
private void cancelAcquire(Node node) {
    // nodeä¸ºç©ºï¼Œè¿”å›
    if (node == null)
        return;
    // è®¾ç½®nodeç»“ç‚¹çš„threadä¸ºç©º
    node.thread = null;
    // ä¿å­˜nodeçš„å‰é©±ç»“ç‚¹
    Node pred = node.prev;
    //æ‰¾åˆ°nodeå‰é©±ç»“ç‚¹ä¸­ç¬¬ä¸€ä¸ªçŠ¶æ€å°äº0çš„ç»“ç‚¹ï¼Œå³ä¸ä¸ºCANCELLEDçŠ¶æ€çš„ç»“ç‚¹
    while (pred.waitStatus > 0)
        node.prev = pred = pred.prev;
    //è·å–predç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹
    Node predNext = pred.next;
    //è®¾ç½®nodeç»“ç‚¹çš„çŠ¶æ€ä¸ºCANCELLED
    node.waitStatus = Node.CANCELLED;
    //nodeç»“ç‚¹ä¸ºå°¾ç»“ç‚¹ï¼Œåˆ™è®¾ç½®å°¾ç»“ç‚¹ä¸ºpredç»“ç‚¹
    if (node == tail && compareAndSetTail(node, pred)) {
        // æ¯”è¾ƒå¹¶è®¾ç½®predç»“ç‚¹çš„nextèŠ‚ç‚¹ä¸ºnull
        compareAndSetNext(pred, predNext, null);
    } else { // nodeç»“ç‚¹ä¸ä¸ºå°¾ç»“ç‚¹ï¼Œæˆ–è€…æ¯”è¾ƒè®¾ç½®ä¸æˆåŠŸ
        int ws;
        if (pred != head &&
                ((ws = pred.waitStatus) == Node.SIGNAL ||
                        (ws <= 0 && compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &&
                pred.thread != null) { // ï¼ˆpredç»“ç‚¹ä¸ä¸ºå¤´ç»“ç‚¹ï¼Œå¹¶ä¸”predç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼‰æˆ–è€… 
            // predç»“ç‚¹çŠ¶æ€å°äºç­‰äº0ï¼Œå¹¶ä¸”æ¯”è¾ƒå¹¶è®¾ç½®ç­‰å¾…çŠ¶æ€ä¸ºSIGNALæˆåŠŸï¼Œå¹¶ä¸”predç»“ç‚¹æ‰€å°è£…çš„çº¿ç¨‹ä¸ä¸ºç©º
            // ä¿å­˜ç»“ç‚¹çš„åç»§
            Node next = node.next;
            if (next != null && next.waitStatus <= 0) // åç»§ä¸ä¸ºç©ºå¹¶ä¸”åç»§çš„çŠ¶æ€å°äºç­‰äº0
                compareAndSetNext(pred, predNext, next); // æ¯”è¾ƒå¹¶è®¾ç½®pred.next = next;
        } else {
            unparkSuccessor(node); // é‡Šæ”¾nodeçš„å‰ä¸€ä¸ªç»“ç‚¹
        }
        node.next = node; // help GC
    }
}
```

å…¶ä¸­å¯¹äº`unparkSuccessor`å‡½æ•°ï¼Œå…¶ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†å”¤é†’ nodeèŠ‚ç‚¹çš„åç»§ç»“ç‚¹ã€‚ä¹Ÿå°±æ˜¯å½“å‰èŠ‚ç‚¹æ‹¿åˆ°é”é‡Šæ”¾ä¹‹åï¼Œå›å»å”¤é†’åç»§ç»“ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶æŠŠé¦–èŠ‚ç‚¹æŒ‡å‘äº†é‡Šæ”¾é”åçš„ä¸‹ä¸€èŠ‚ç‚¹ã€‚æºç å¦‚ä¸‹ï¼š

```java
 //é‡Šæ”¾åç»§ç»“ç‚¹
 private void unparkSuccessor(Node node) {
     // è·å–nodeç»“ç‚¹çš„ç­‰å¾…çŠ¶æ€
     int ws = node.waitStatus;
     if (ws < 0) // çŠ¶æ€å€¼å°äº0ï¼Œä¸ºSIGNAL -1 æˆ– CONDITION -2 æˆ– PROPAGATE -3
         // æ¯”è¾ƒå¹¶ä¸”è®¾ç½®ç»“ç‚¹ç­‰å¾…çŠ¶æ€ï¼Œè®¾ç½®ä¸º0
         compareAndSetWaitStatus(node, ws, 0);
     // è·å–nodeèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹
     Node s = node.next;
     if (s == null || s.waitStatus > 0) { //ä¸‹ä¸€ä¸ªç»“ç‚¹ä¸ºç©ºæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€å¤§äº0ï¼Œå³ä¸ºCANCELLEDçŠ¶æ€ï¼Œæ­¤æ—¶ä¼šä»å°¾ç»“ç‚¹å¾€å‰æ‰¾ä¸æ˜¯CANCELLEDçŠ¶æ€çš„èŠ‚ç‚¹
         // sèµ‹å€¼ä¸ºç©º
         s = null;
         // ä»å°¾ç»“ç‚¹å¼€å§‹ä»åå¾€å‰å¼€å§‹éå†
         for (Node t = tail; t != null && t != node; t = t.prev)
             if (t.waitStatus <= 0) // æ‰¾åˆ°ç­‰å¾…çŠ¶æ€å°äºç­‰äº0çš„ç»“ç‚¹ï¼Œæ‰¾åˆ°æœ€å‰çš„çŠ¶æ€å°äºç­‰äº0çš„ç»“ç‚¹
                 // ä¿å­˜ç»“ç‚¹
                 s = t;
     }
     if (s != null) // è¯¥ç»“ç‚¹ä¸ä¸ºä¸ºç©ºï¼Œé‡Šæ”¾è®¸å¯
         LockSupport.unpark(s.thread);
 }
```

ç„¶åå†å›åˆ°ä¸Šé¢é—ç•™çš„é—®é¢˜ï¼Œ**ä¸ºä»€ä¹ˆå¿…é¡»å‰é©±ç»“ç‚¹ä¸ºå¤´ç»“ç‚¹æ‰å°è¯•å»è·å–é”ï¼Ÿ**åŸå› æœ‰ä¸¤ä¸ªï¼š

1. **å› ä¸ºå¤´ç»“ç‚¹è¡¨ç¤ºå½“å‰æ­£å æœ‰é”çš„çº¿ç¨‹**ã€‚æˆ‘ä»¬æƒ³æƒ³å¤´ç»“ç‚¹æœ‰ä»€ä¹ˆï¼Ÿå¤´èŠ‚ç‚¹ä»£è¡¨ç¬¬ä¸€ä¸ªè¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹ï¼Œ**æ³¨æ„æ˜¯**è¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹ï¼Œä¸æ˜¯æŒ‡ä¸Šé¢ä¾‹å­çš„`t1`ï¼Œä¸Šé¢çš„ä¾‹å­`t2`çº¿ç¨‹æ‰æ˜¯ç¬¬ä¸€ä¸ªè¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹ï¼Œå¦‚æœ`t1`è¿™æ—¶å€™é‡Šæ”¾äº†é”ä¸”åŒæ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ¥ç«äº‰é”ï¼Œé‚£ä¹ˆå®ƒå°†ç›´æ¥æ‹¿åˆ°é”ï¼Œå¹¶æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€`state`ï¼Œå³**å¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹**ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ç¬¬äºŒä¸ªçº¿ç¨‹è¿›å…¥é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå®ƒä¼šå»çœ‹å®ƒçš„å‰é©±èŠ‚ç‚¹æ˜¯å¦æ˜¯å¤´ç»“ç‚¹ï¼Œå› ä¸ºå¤´ç»“ç‚¹æœ‰åŒæ­¥çŠ¶æ€`state`ï¼Œå¦‚æœåˆšå¥½é‡Šæ”¾é‚£ä¹ˆä»–å°±ç«‹åˆ»è·å–é”ï¼Œå¦è€…æ’é˜Ÿé˜»å¡ã€‚
2. **ç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™**ã€‚å½“çº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€åï¼Œè®©é¦–èŠ‚ç‚¹è¿™ä¸ªå¼•ç”¨æŒ‡å‘è‡ªå·±æ‰€åœ¨èŠ‚ç‚¹ã€‚å½“åŒæ­¥çŠ¶æ€è·å–æˆåŠŸåï¼Œå½“å‰çº¿ç¨‹å°±ä» acquire æ–¹æ³•è¿”å›äº†ã€‚å¦‚æœåŒæ­¥å™¨å®ç°çš„æ˜¯é”ï¼Œé‚£å°±ä»£è¡¨å½“å‰çº¿ç¨‹è·å¾—äº†é”ã€‚

å› æ­¤ï¼Œ**è¿›å…¥é˜Ÿåˆ—**å’Œ**æ’é˜Ÿ**æ˜¯ä¸¤å›äº‹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è¿›å…¥é˜Ÿåˆ—äº†æˆ‘å¹¶ä¸ä¸€å®šå°±æ˜¯åœ¨æ’é˜Ÿï¼ˆparkï¼‰ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

æ¯”å¦‚æˆ‘ä»¬å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œå¦‚æœè¯´æˆ‘ä»¬çœ‹åˆ°å”®ç¥¨çª—å£å¤„äºç©ºé—²çŠ¶æ€ï¼Œå³æ²¡äººæ’é˜Ÿä¹°ç¥¨ï¼Œé‚£è¿™ä¸ªæ—¶å€™ä½ å°±ç›´æ¥å»ä¹°å°±è¡Œï¼Œå¦‚æœæœ‰äººåœ¨æ’é˜Ÿï¼Œä¸€èˆ¬æ¥è¯´æ’é˜Ÿçš„æ—¶å€™æˆ‘ä»¬å¯èƒ½å°±ä¼šç©ç©æ‰‹æœºï¼Œä½†ä¸æ˜¯ä¸€å®šæ’é˜Ÿå°±ä¼šå»ç©æ‰‹æœºï¼Œä½ ä¼šçœ‹çœ‹å‰é¢é‚£ä¸ªäººæ˜¯ä¸æ˜¯ç¬¬ä¸€ä¸ªäººï¼Œå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªäººçš„è¯ï¼Œé‚£å¯èƒ½é©¬ä¸Šå°±è½®åˆ°ä½ äº†ï¼Œä½ å°±ä¸ç”¨æå‡ºæ‰‹æœºæ¥ç©äº†ï¼Œå¦‚æœä¸æ˜¯å¾—è¯ï¼Œä½ æ‰æå‡ºæ‰‹æœºç©ç›´åˆ°ä½ å‰é¢åªæœ‰ä¸€ä¸ªäººçš„æ—¶å€™æ‰æ”¶èµ·æ‰‹æœºã€‚

#### å°ç»“

æ€»ç»“ä¸€ä¸‹éå…¬å¹³é”è·å–é”çš„æµç¨‹ï¼š

1. ç¬¬ä¸€æ¬¡å»è·å–é”çš„æ—¶å€™ï¼Œä¼šå»å°è¯•å»åŠ é”ã€‚
2. å¦‚æœåŠ é”å¤±è´¥ï¼Œåˆ™å»çœ‹ä¸ºä»€ä¹ˆå¤±è´¥ï¼ˆæ˜¯å¦é”è¢«äººæŒæœ‰äº†ï¼‰ã€‚
3. åœ¨åˆ¤æ–­çš„è¿‡ç¨‹ä¸­å¦‚æœé”æ²¡æœ‰è¢«æŒæœ‰ï¼Œéå…¬å¹³é”å°±ä¼šå»ç›´æ¥åŠ é”ï¼ˆä¸ä¼šåˆ¤æ–­æ˜¯å¦æœ‰äººæ’é˜Ÿï¼‰ï¼ŒæˆåŠŸåˆ™è¿›å…¥åŒæ­¥å—ï¼Œå¤±è´¥åˆ™è¿›å…¥é˜Ÿåˆ—ã€‚
4. è¿›å…¥é˜Ÿåˆ—åå¦‚æœå‰é¢è·å–é”çš„èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ head åˆ™å†æ¬¡å°è¯•åŠ é”ï¼ŒæˆåŠŸåˆ™æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œå¤±è´¥åˆ™`park()`ï¼ˆçœŸæ­£çš„æ’é˜Ÿï¼‰ã€‚

![image-20210928235857381](https://cdn.javatv.net/note/20210928235857.png)

### è§£é”æµç¨‹

è§£é”æµç¨‹å°±æ¯”è¾ƒç®€å•ã€‚

1ã€`unlock()`

```java
public void unlock() {
    sync.release(1);
}
```

2ã€`release()`

```java
public final boolean release(int arg) {
    //è‹¥å°è¯•é‡Šæ”¾é”æˆåŠŸ
    if (tryRelease(arg)) {
        //å…ˆè·å–å¤´ç»“ç‚¹
        Node h = head;
       	//å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºnullä¸”èŠ‚ç‚¹çš„çŠ¶æ€ä¸ä¸º0
        if (h != null && h.waitStatus != 0)
            //å”¤é†’åç»§èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹
            unparkSuccessor(h);
        return true;
    }
    return false;
}
```

è¯¥æ–¹æ³•åœ¨ if è¯­å¥ä¸­è°ƒç”¨äº†`tryRelease()`ï¼Œæºç å¦‚ä¸‹ï¼š

```java
protected final boolean tryRelease(int releases) {
    //è·å–AQSä¸­çš„åŒæ­¥çŠ¶æ€å¹¶è®¡ç®—
    int c = getState() - releases;
    //åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œä¸æ˜¯å°±æŠ›å¼‚å¸¸(ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿ)
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    //é‡Šæ”¾æ ‡è¯†
    boolean free = false;
    //å¦‚æœå½“å‰çŠ¶æ€ä¸º0ï¼Œè¯´æ˜å¯é‡Šæ”¾é”ï¼ŒæŠŠæ ‡è¯†æ”¹ä¸ºtrue
    if (c == 0) {
        free = true;
        setExclusiveOwnerThread(null);
    }
    //æ›´æ–°state
    setState(c);
    return free;
}
```

`tryRelease()`çš„ä½œç”¨æ˜¯å°†çº¿ç¨‹æŒæœ‰é”çš„æ¬¡æ•°å‡ 1 ï¼Œå³å°† state å€¼å‡1ï¼Œè‹¥å‡å°‘åçº¿ç¨‹å°†å®Œå…¨é‡Šæ”¾é”(`state==0`)ï¼Œåˆ™è¯¥æ–¹æ³•å°†è¿”å› trueï¼Œå¦åˆ™è¿”å›falseã€‚ç”±äºæ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹å¿…ç„¶æŒæœ‰é”ï¼Œæ•…è¯¥æ–¹æ³•ä¸éœ€è¦ä»»ä½•åŒæ­¥æ“ä½œï¼Œç­‰å¾…æµç¨‹èµ°å®Œå³å¯ã€‚**è‹¥å½“å‰çº¿ç¨‹å·²ç»å®Œå…¨é‡Šæ”¾é”ï¼Œå³é”å¯è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œåˆ™è¿˜åº”è¯¥å”¤é†’åç»­ç­‰å¾…çº¿ç¨‹**ã€‚

è‹¥`tryRelease()`å°è¯•é‡Šæ”¾é”è¿”å› trueï¼Œåˆ™éœ€è¦æ»¡è¶³ if è¯­å¥ä¸­çš„2ä¸ªæ¡ä»¶ï¼š

- `head != null`ã€‚é˜²æ­¢é˜Ÿåˆ—ä¸ºç©ºé˜Ÿåˆ—ï¼Œè‹¥å¤´èŠ‚ç‚¹ä¸ºnullï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—ä¸­æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¤„äºé˜Ÿåˆ—ä¸­ï¼Œå½“ç„¶ä¹Ÿå°±æ— éœ€æ‰§è¡Œå”¤é†’æ“ä½œã€‚
- `h.waitStatus != 0`ã€‚æ˜¯ä¸ºäº†é˜²æ­¢é˜Ÿåˆ—ä¸­è™½æœ‰çº¿ç¨‹ï¼Œä½†è¯¥çº¿ç¨‹è¿˜æœªé˜»å¡ï¼Œç”±å‰é¢çš„åˆ†æçŸ¥ï¼Œçº¿ç¨‹åœ¨é˜»å¡è‡ªå·±å‰å¿…é¡»è®¾ç½®å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼Œå¦åˆ™å®ƒä¸ä¼šé˜»å¡è‡ªå·±ã€‚å¦‚æœæ²¡é˜»å¡é‚£ä¹Ÿå°±ä¸éœ€è¦è¢«å”¤é†’ã€‚

å¦‚æœä¸Šè¿°2ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™éœ€è¦é€šè¿‡`unparkSuccessor()`å»å”¤é†’åç»§èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š

```java
private void unparkSuccessor(Node node) {
   	//å¤´ç»“ç‚¹çš„çŠ¶æ€
    int ws = node.waitStatus;
    /**
 	 * å°è¯•å°†wsæ”¹ä¸º 0 ï¼Œå³ä½¿å¤±è´¥ä¹Ÿæ— æ‰€è°“ã€‚
 	 * è¿™é‡Œä½¿ç”¨casçš„æ–¹å¼ä¿®æ”¹æ˜¯å› ä¸ºä»–çš„å‰ç½®èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¿®æ”¹ä»–çš„waitStatus
	 * å°†wsæ›´æ–°ä¸º0çš„ç†ç”±æ˜¯è®©å”¤é†’çš„çº¿ç¨‹å¯ä»¥å¤šä¸€è½®ç«äº‰ã€‚æé«˜ç«äº‰ç‡
	 */
    if (ws < 0)
        compareAndSetWaitStatus(node, ws, 0);
    //å¤´ç»“ç‚¹çš„åç»§èŠ‚ç‚¹
    Node s = node.next;
    //å½“å¤´ç»“ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºç©ºæˆ–è€…å·²ç»è¢«å–æ¶ˆæ—¶æˆ–è€…é‡Šæ”¾
    if (s == null || s.waitStatus > 0) {
        s = null;
        /**
         * ä»é˜Ÿåˆ—å°¾éƒ¨å¾€å‰å›æº¯,ä»åå°¾éƒ¨å¾€å‰éå†æ‰¾åˆ°æœ€å‰çš„ä¸€ä¸ªå¤„äºæ­£å¸¸é˜»å¡çŠ¶æ€çš„ç»“ç‚¹,å¹¶å”¤é†’å…¶çº¿ç¨‹ã€‚
         * æä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆä»å°¾éƒ¨è€Œä¸æ˜¯ä»å¤´éƒ¨ï¼Ÿç»“å°¾æœ‰ç­”æ¡ˆã€‚
         */
        for (Node t = tail; t != null && t != node; t = t.prev)
            if (t.waitStatus <= 0)
                s = t;
    }
    //è‹¥åç»§èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å³å¯
    if (s != null)
        LockSupport.unpark(s.thread);
}
```

ä¸€èˆ¬æƒ…å†µä¸‹åªè¦å”¤é†’åç»§ç»“ç‚¹çš„çº¿ç¨‹å°±è¡Œäº†ï¼Œä½†æ˜¯åç»§ç»“ç‚¹å¯èƒ½å·²ç»å–æ¶ˆç­‰å¾…ï¼Œæ‰€ä»¥ä»é˜Ÿåˆ—å°¾éƒ¨å¾€å‰å›æº¯ï¼Œæ‰¾åˆ°ç¦»å¤´ç»“ç‚¹æœ€è¿‘çš„æ­£å¸¸ç»“ç‚¹ï¼Œå¹¶å”¤é†’å…¶çº¿ç¨‹ã€‚

ä¸»è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºè¿™é‡Œæ˜¯éå…¬å¹³é”ï¼Œæ‰€ä»¥**å”¤é†’ä¸ç­‰äºæ‹¥æœ‰é”**ï¼Œå› ä¸ºåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¦‚æœæœ‰å¤–éƒ¨çš„çº¿ç¨‹ä¹Ÿæ¥è·å–é”ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„åŒæ­¥çŠ¶æ€å·²ç»æ”¹ä¸ºäº†0ï¼ŒCASæˆåŠŸè·å–é”ï¼Œè€Œ`s.thread`è¢«å”¤é†’åè¿˜æ˜¯ä¹Ÿéœ€è¦é€šè¿‡`tryAcquire()` æ–¹æ³•å»ç«äº‰ï¼Œå¦‚æœç«äº‰å¤±è´¥åˆ™ç»§ç»­é˜»å¡ï¼Œç­‰ç€è·å–çš„çº¿ç¨‹å†æ¬¡å”¤é†’è‡ªå·±ã€‚

å½“ç„¶ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯å…¬å¹³é”ï¼ˆfairï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¸€å®šä¼šè¢«å”¤é†’ï¼Œå› ä¸ºå…¶ä»–æ¥çš„çº¿ç¨‹ä¸ä¼šé¦–å…ˆå»è·å–é”ï¼Œè€Œæ˜¯ç›´æ¥è¢«æ”¾åˆ°é˜Ÿå°¾ã€‚

## å…¬å¹³é”

### åŠ é”æµç¨‹

å¯¹äºå…¬å¹³é”æˆ‘ä»¬ä¾æ—§é€šè¿‡å…¥å£`lock()`åˆ†æï¼š

1ã€`lock()`ã€‚`FairSync`ç±»çš„æ–¹æ³•ã€‚

```java
public void lock() {
    sync.lock();
}
```

2ã€`acquire()`ã€‚

```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) &&
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```

3ã€`tryAcquire()`ã€‚`FairSync`ç±»çš„æ–¹æ³•ã€‚

```java
protected final boolean tryAcquire(int acquires) {
	// è·å–å½“å‰çº¿ç¨‹
    final Thread current = Thread.currentThread();
    //è·å–çŠ¶æ€
    int c = getState();
    if (c == 0) {
        if (!hasQueuedPredecessors() &&
            compareAndSetState(0, acquires)) {
            // è®¾ç½®å½“å‰çº¿ç¨‹ç‹¬å 
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    // çŠ¶æ€ä¸ä¸º0ï¼Œå³èµ„æºå·²ç»è¢«çº¿ç¨‹å æ®
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0)
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

å¯¹æ¯”éå…¬å¹³é”çš„`tryAcquire()`å‘ç°ä¸åŒç‚¹ï¼Œå¤šäº†ä¸€ä¸ª`hasQueuedPredecessors()`æ–¹æ³•ï¼š

```java
public final boolean hasQueuedPredecessors() {
    // The correctness of this depends on head being initialized
    // before tail and on head.next being accurate if the current
    // thread is first in queue.
    Node t = tail; // Read fields in reverse initialization order
    Node h = head;
    Node s;
    return h != t &&
        ((s = h.next) == null || s.thread != Thread.currentThread());
}
```

å…ˆç†è§£å­—é¢æ„æ€ï¼Œè¯¥æ–¹æ³•æ˜¯**åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„ç­‰å¾…çº¿ç¨‹**ï¼Œé˜Ÿåˆ—ä¸­å“ªä¸ªçº¿ç¨‹ä¼˜å…ˆçº§æœ€é«˜ï¼Ÿç”±äºå¤´ç»“ç‚¹æ˜¯å½“å‰è·å–é”çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„ç¬¬äºŒä¸ªç»“ç‚¹ä»£è¡¨çš„çº¿ç¨‹ä¼˜å…ˆçº§æœ€é«˜ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­é˜Ÿåˆ—ä¸­çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ä»¥åŠè¿™ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ã€‚

å…ˆæŠŠä¸Šé¢ `return` çš„ä»£ç åˆ†è§£å¼€æ¥åˆ†æï¼š

- `h != t`

  å½“å®ƒä»¬ä¸º`fasle`è¯´æ˜å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹æŒ‡å‘åŒä¸€èŠ‚ç‚¹ï¼Œå³ä¸Šä¸ªèŠ‚ç‚¹è·å–é”çš„èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ headï¼Œç„¶åCASå°è¯•åŠ é”ï¼Œå¦è€…èµ°ä¸‹é¢çš„åˆ¤æ–­ã€‚

- `(s = h.next) == null || s.thread != Thread.currentThread()`

  **ç¬¬äºŒä¸ªèŠ‚ç‚¹ä¸å­˜åœ¨**ï¼š

  è¿™ä¸ªä¸å­˜åœ¨å¹¶ä¸æ˜¯çœŸçš„ä¸å­˜åœ¨ï¼Œåªæ˜¯ç”±äºCPUä¸Šä¸‹æ–‡åˆ‡æ¢çš„åŸå› ï¼Œé€šè¿‡å¯¹éå…¬å¹³é”çš„å…¥é˜Ÿ`enq()`æ–¹æ³•æˆ‘ä»¬å¯ä»¥çŸ¥é“èŠ‚ç‚¹å…¥é˜Ÿæœ‰ä¸‰æ­¥ï¼š

  â‘  å°†å¾…æ’å…¥ç»“ç‚¹çš„ prevæŒ‡é’ˆ è¿æ¥åˆ°åŸå°¾ç»“ç‚¹ã€‚

  â‘¡ CASæ›´æ–°å°¾æŒ‡é’ˆã€‚

  â‘¢ æŠŠåŸå°¾ç»“ç‚¹çš„ next æŒ‡é’ˆæŒ‡å‘å¾…æ’å…¥ç»“ç‚¹ã€‚

  å› æ­¤`s = h.next`çš„ä½œç”¨æ˜¯ç”¨æ¥åˆ¤æ–­ â‘¡ åˆšæ‰§è¡Œå®Œæˆï¼Œä½†æ˜¯è¿˜æœªæ‰§è¡Œ â‘¢ è¿™ç§æƒ…å†µï¼Œå¦‚æœæ˜¯è¿™ç§æƒ…å†µç›´æ¥è¿”å›**true**ï¼Œå³`s = h.next ==null = true` ï¼Œé‚£ä¹ˆ`hasQueuedPredecessors()`è¿”å›**true**ï¼Œ`tryAcquire()`è¿”å› **false**ï¼Œç„¶åè¿›å…¥é˜Ÿåˆ—ä¹–ä¹–æ’é˜Ÿã€‚

  **ç¬¬äºŒä¸ªèŠ‚ç‚¹å­˜åœ¨ä¸”æ˜¯å¦ä»£è¡¨å½“å‰çº¿ç¨‹**ï¼š

  å¦‚æœ`s = h.next == null = false`ï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªèŠ‚ç‚¹å·²ç»å®Œå…¨æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œé€šè¿‡`s.thread != Thread.currentThread()`è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸º **true**ï¼Œè¯´æ˜ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œé˜Ÿåˆ—ä¸­å‰é¢è¿˜æœ‰æœªæ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ‰€ä»¥è¿›å…¥é˜Ÿåˆ—ä¹–ä¹–æ’é˜Ÿã€‚å¦åˆ™ï¼Œè¯´æ˜é˜Ÿåˆ—æ²¡æœ‰æ’é˜Ÿçš„çº¿ç¨‹äº†ï¼Œç›´æ¥è·å–é”ã€‚

### è§£é”æµç¨‹

å…¬å¹³é”çš„é‡Šæ”¾åŒéå…¬å¹³é”çš„é‡Šæ”¾ã€‚

## é¢è¯•é¢˜

**1ã€ä»€ä¹ˆæ˜¯éå…¬å¹³é”ï¼Œä»€ä¹ˆæ˜¯å…¬å¹³é”ï¼Ÿ**

éå…¬å¹³é”ï¼š

1. ç¬¬ä¸€æ¬¡å»è·å–é”çš„æ—¶å€™ï¼Œä¼šå»å°è¯•å»åŠ é”ã€‚
2. å¦‚æœåŠ é”å¤±è´¥ï¼Œåˆ™å»çœ‹ä¸ºä»€ä¹ˆå¤±è´¥ï¼ˆæ˜¯å¦é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰äº†ï¼‰ã€‚
3. åœ¨åˆ¤æ–­çš„è¿‡ç¨‹ä¸­å¦‚æœé”æ²¡æœ‰è¢«æŒæœ‰ï¼Œéå…¬å¹³é”å°±ä¼šå»ç›´æ¥åŠ é”ï¼ˆä¸ä¼šåˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æ’é˜Ÿï¼‰ï¼ŒæˆåŠŸåˆ™è¿›å…¥åŒæ­¥å—ï¼Œå¤±è´¥åˆ™è¿›å…¥é˜Ÿåˆ—ï¼ˆ**å¹¶ä¸ç­‰äºæ’é˜Ÿ**ï¼‰ã€‚
4. è¿›å…¥é˜Ÿåˆ—åå¦‚æœå‰é¢è·å–é”çš„èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ head åˆ™å†æ¬¡å°è¯•åŠ é”ï¼ŒæˆåŠŸåˆ™æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼Œå¤±è´¥åˆ™`park()`ï¼ˆçœŸæ­£çš„æ’é˜Ÿï¼‰ã€‚

å…¬å¹³é”ï¼š

1. ç¬¬ä¸€æ¬¡å»è·å–é”çš„æ—¶å€™ï¼Œä¸ä¼šå»å°è¯•åŠ é”ï¼Œä¼šå»çœ‹ä¸€ä¸‹å‰é¢æœ‰æ²¡æœ‰çº¿ç¨‹åœ¨æ’é˜Ÿï¼ˆ`hasQueuedPredecessors`ï¼‰ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿›å…¥é˜Ÿåˆ—ï¼ˆ**å¹¶ä¸ç­‰äºæ’é˜Ÿ**ï¼‰ã€‚
2. ç„¶åè¿˜ä¸æ­»å¿ƒï¼Œå†æ¬¡çœ‹ä¸€ä¸‹æˆ‘æœ‰æ²¡æœ‰æ‹¿é”çš„èµ„æ ¼ï¼ˆå‰é¢é‚£ä¸ªäººæ˜¯å¦ä¸ºheadï¼ŒåŒéå…¬å¹³é”ï¼‰ï¼Œå¦‚æœæœ‰èµ„æ ¼ï¼ˆå‰é¢èŠ‚ç‚¹åˆšå¥½ä¸ºheadï¼‰åˆ™ç»§ç»­æ‹¿é”ï¼ŒæˆåŠŸåˆ™æ‰§è¡ŒåŒæ­¥å—ï¼Œå¤±è´¥åˆ™parkï¼ˆæ’é˜Ÿï¼‰ã€‚

è®°ä½ä¸€å¥è¯ï¼š**ä¸€æœæ’é˜Ÿï¼Œæ°¸è¿œæ’é˜Ÿ**ã€‚

**2ã€åœ¨è§£é”è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ`unparkSuccessor()` æ–¹æ³•ä¸­forå¾ªç¯æ˜¯ä»tailå¼€å§‹è€Œä¸æ˜¯headï¼Ÿ**

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**Doug Lea** ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿå…¶å¿…ç„¶æ˜¯ä¸ºäº†è§£å†³æŸäº›é—®é¢˜ï¼Ÿè€Œè¿™ä¸ªé—®é¢˜å°±å‡ºåœ¨å…¥é˜Ÿè¿‡ç¨‹çš„`enq()`æ–¹æ³•ï¼š

```java
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        //è‹¥tailä¸ºnullï¼Œè¯´æ˜é˜Ÿåˆ—æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹
        if (t == null) { // Must initialize
            //æ„é€ æ–°ç»“ç‚¹,CASæ–¹å¼è®¾ç½®ä¸ºé˜Ÿåˆ—é¦–å…ƒç´ ,å½“head==nullæ—¶æ›´æ–°æˆåŠŸ
            if (compareAndSetHead(new Node()))
            	//å¤´ç»“ç‚¹ä¸å°¾ç»“ç‚¹éƒ½æŒ‡å‘åŒä¸€ä¸ªæ–°ç”Ÿç»“ç‚¹
                tail = head;
        } else {//è‹¥tailä¸ä¸ºnullï¼Œå³å·²ç»è¢«åˆå§‹åŒ–è¿‡
        	//å°†nodeç»“ç‚¹çš„prevè¿æ¥åˆ°åŸå°¾ç»“ç‚¹
            node.prev = t;
            //CASæ¯”è¾ƒç»“ç‚¹tæ˜¯å¦ä¸ºå°¾ç»“ç‚¹ï¼Œè‹¥æ˜¯åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºnode
            if (compareAndSetTail(t, node)) {
            	//æŠŠåŸå°¾ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹node
                t.next = node;
                return t;
            }
        }
    }
}
```

å¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–é˜Ÿåˆ—åï¼Œ`else`ä»£ç å—ä¸­æ˜¯æ²¡æœ‰åˆ©ç”¨ä»»ä½•æ‰‹æ®µæ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚è‹¥æœ‰å…¶ä»–çº¿ç¨‹å…¥é˜Ÿï¼Œåœ¨å…¥é˜Ÿä¹‹å‰çš„é˜Ÿåˆ—çŠ¶æ€ä¸ºï¼š

![image-20210929114300966](https://cdn.javatv.net/note/20210929114301.png)

- è‹¥çº¿ç¨‹ A åˆ°æ¥åˆ™å…ˆæ‰§è¡Œ`node.prev = t`ï¼Œç„¶åå¹¶é€šè¿‡CASæŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ï¼Œæ­¤æ—¶æ­£å¸¸æƒ…å†µä¸‹å°†æ‰§è¡Œ`t.next = node`ï¼Œå¦‚ä¸‹ï¼š

  ![image-20210929115200822](https://cdn.javatv.net/note/20210929115200.png)

- åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸Šé¢æ˜¯æ²¡é—®é¢˜çš„ï¼Œæˆ‘ä»¬çŸ¥é“CASæ˜¯åŸºäºCPUçš„ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹ B ä¹Ÿåˆ°æ¥ï¼Œå³å½“Aè¿˜æ²¡æœ‰æ‰§è¡Œå®Œ`t.next = node`è¿™ä¸€æ­¥æ—¶ï¼ŒCPUå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒæŠŠæ—¶é—´ç‰‡ç»™äº† Bï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹ B åˆ™å¼€å§‹æ‰§è¡Œ`enq()`å…¥é˜Ÿæ“ä½œï¼Œä¸ç®¡çº¿ç¨‹ B æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œä½†æ­¤æ—¶å¯¹äºä¸Šå›¾ä¸­çš„`node`èŠ‚ç‚¹æ¥è¯´ï¼š`node.next = null`ã€‚

  ![image-20210929120438193](https://cdn.javatv.net/note/20210929120438.png)

- ç„¶åCPUå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒæŠŠæ—¶é—´ç‰‡ç»™äº†çº¿ç¨‹ C ï¼Œçº¿ç¨‹ C æ˜¯è§£é”çº¿ç¨‹è°ƒç”¨`unparkSuccessor()` æ–¹æ³•ï¼Œå¦‚æœæ­¤æ—¶æ˜¯**ä»å¤´åˆ°å°¾**çš„æ–¹å¼ï¼Œåˆ™å‘ç°`node.next = null`ï¼Œä¼šå‘ç°æ²¡ååç»§èŠ‚ç‚¹äº†ã€‚

- ä½†æ­¤æ—¶å†æ¬¡å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ—¶é—´ç‰‡äº¤ç”±çº¿ç¨‹ Aï¼ŒA æ‰§è¡Œ`t.next = node`ï¼Œåˆ™æ­¤æ—¶`node.next = nodeA`ã€‚æ‰€ä»¥é—®é¢˜å°±æ¥äº†ï¼š**å¯¹äºçº¿ç¨‹Cæ¥è¯´ï¼Œåç»­æ²¡æœ‰nodeAåŠåç»­èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯¹äºå…¶å®ƒçº¿ç¨‹æ¥è¯´ï¼Œå´æœ‰è¿™ä¸ªèŠ‚ç‚¹**ã€‚

**é‚£ä¹ˆä¸ºä»€ä¹ˆä»å°¾éƒ¨éå†ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜å‘¢ï¼Ÿ**

æ˜¯å› ä¸º`node.prev = t`å…ˆäºCASæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ åœ¨å°†å½“å‰èŠ‚ç‚¹ç½®ä¸ºå°¾éƒ¨ä¹‹å‰å°±å·²ç»æŠŠå‰é©±èŠ‚ç‚¹èµ‹å€¼äº†ï¼Œè‡ªç„¶ä¸ä¼šå‡ºç°`prev = null`çš„æƒ…å†µã€‚

å‚è€ƒï¼šhttps://blog.csdn.net/foxException/article/details/108917338

**3ã€ä¸ºä»€ä¹ˆé€‰æ‹©éå…¬å¹³é”ï¼Ÿ**

ä¸€åˆ‡ä¸ºäº†æ•ˆç‡ã€‚